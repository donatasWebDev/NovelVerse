FROM nvidia/cuda:11.8.0-runtime-ubuntu22.04

# Install Python + pip FIRST (so Torch pip works)
RUN apt-get update && \
    apt-get install -y --no-install-recommends python3.10 python3-pip git && \
    ln -sf /usr/bin/python3.10 /usr/bin/python && \
    ln -sf /usr/bin/pip3 /usr/bin/pip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*



WORKDIR /app/socket

# Now Torch pip works
RUN pip install --no-cache-dir torch==2.1.0+cu118 torchvision==0.16.0+cu118 torchaudio==2.1.0 --index-url https://download.pytorch.org/whl/cu118

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ffmpeg \
        libmp3lame0 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# Chrome deps + install (your full block)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        wget gnupg ca-certificates fonts-liberation libasound2 libatk-bridge2.0-0 \
        libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 \
        libfontconfig1 libgcc1 libglib2.0-0 libgtk-3-0 libnspr4 libnss3 \
        libpango-1.0-0 libx11-6 libxcomposite1 libxdamage1 libxrandr2 xdg-utils && \
    wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg && \
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] https://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends google-chrome-stable && \
    apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Your reqs
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Clean pip cache
RUN pip cache purge

# GPU env
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

# Code
COPY . /app/socket/

EXPOSE 12345
CMD ["python", "/app/py_socket.py"]