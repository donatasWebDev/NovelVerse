version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "5173:5173"  # React dev server or nginx
    volumes:
      - ./frontend:/app/frontend  # hot reload if dev server
    environment:
      - CHOKIDAR_USEPOLLING=true  # for Vite hot reload in container
    depends_on:
      - py_socket

  py_socket:
    build:
      context: ./py_server
      dockerfile: Dockerfile-socket
    ports:
      - "12345:12345"  # WebSocket for local testing
    runtime: nvidia  # GPU passthrough
    environment:
      - PYTHONUNBUFFERED=1
      - PY_SERVER_URL=http://py_server:4001
      - NODE_BACK_URL=http://backend:4000  # internal to Node backend
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ./py_server:/app/socket  # hot reload
    depends_on:
      - py_server
      - backend

  py_server:
    build:
      context: ./py_server
      dockerfile: Dockerfile-server
    ports:
      - "4001:4001"
    environment:
      - NODE_BACK_URL=http://backend:8001
    volumes:
      - ./py_server:/app/server
    depends_on:
      - backend

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "4000:4000"  # Express TS backend
    volumes:
      - ./backend:/app/backend
    command: ["ts-node", "index.ts"]  # or your start command
    environment:
      - NODE_ENV=development